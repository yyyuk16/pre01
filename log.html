<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ‚£è€…ãƒ­ã‚°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="log.css">
    <link rel="stylesheet" href="responsive.css">
</head>
<body>
    <div class="container">
        <div class="header" style="position:relative;display:flex;align-items:center;justify-content:center;min-height:60px;">
            <button onclick="location.href='list.html'" class="back-btn">â† æˆ»ã‚‹</button>
            <h1 style="flex:1;text-align:center;margin:0;">æ‚£è€…ãƒ­ã‚°</h1>
        </div>

        <div class="patient-info">
            <h2>åŸºæœ¬æƒ…å ±</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">åå‰</div>
                    <div id="patientName">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å¹´é½¢</div>
                    <div id="patientAge">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ€§åˆ¥</div>
                    <div id="patientGender">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æœ€çµ‚è¨ºæ–­æ—¥</div>
                    <div id="lastVisit">-</div>
                </div>
            </div>
        </div>

        <div class="history-section">
            <h2>è¨ºæ–­å±¥æ­´</h2>
            <div id="diagnosisHistory">
                <!-- è¨ºæ–­å±¥æ­´ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <div class="history-section">
            <h2>ã‚¯ã‚¤ã‚ºçµæœ</h2>
            <div class="quiz-results" id="quizResults">
                <!-- ã‚¯ã‚¤ã‚ºçµæœãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="responsive.js"></script>
    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyC31W-TEE7mIBGFwrRxJAuPugjnEFfWe_k",
            authDomain: "web01-2484d.firebaseapp.com",
            projectId: "web01-2484d",
            storageBucket: "web01-2484d.appspot.com",
            messagingSenderId: "90159472898",
            appId: "1:90159472898:web:261ec71f9919611011e21b"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // URLã‹ã‚‰æ‚£è€…IDã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get('id') || urlParams.get('uid');

        // æ‚£è€…æƒ…å ±ã®å–å¾—ã¨è¡¨ç¤º
        async function loadPatientData() {
            try {
                // patientsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å„ªå…ˆã€ãªã‘ã‚Œã°usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—
                let data = null;
                let docRef = await db.collection('patients').doc(patientId).get();
                if (docRef.exists) {
                    data = docRef.data();
                } else {
                    docRef = await db.collection('users').doc(patientId).get();
                    if (docRef.exists) {
                        data = docRef.data();
                    }
                }
                if (data) {
                    document.getElementById('patientName').textContent = data.name || '-';
                    document.getElementById('patientAge').textContent = data.age || '-';
                    document.getElementById('patientGender').textContent = data.gender || '-';
                    
                    // æœ€çµ‚è¨ºæ–­æ—¥ã¯è¨ºæ–­å±¥æ­´ã‹ã‚‰å–å¾—ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä¸€æ™‚çš„ã«ã€Œ-ã€ã‚’è¡¨ç¤º
                    document.getElementById('lastVisit').textContent = '-';
                }
            } catch (error) {
                console.error('æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        }

        // è¨ºæ–­å±¥æ­´ã®å–å¾—ã¨è¡¨ç¤º
        async function loadDiagnosisHistory() {
            try {
                const historyContainer = document.getElementById('diagnosisHistory');
                historyContainer.innerHTML = '';

                // usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æ‚£è€…ã®ãƒ¡ãƒ¢å±¥æ­´ã‚’å–å¾—
                const userDoc = await db.collection('users').doc(patientId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const memos = userData.memos || [];

                    if (memos.length === 0) {
                        historyContainer.innerHTML = '<div class="diagnosis-entry">è¨ºæ–­å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
                        return;
                    }

                    // ãƒ¡ãƒ¢ã‚’æ—¥ä»˜é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                    memos.sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return dateB - dateA;
                    });

                    memos.forEach(memo => {
                        const historyCard = document.createElement('div');
                        historyCard.className = 'diagnosis-entry';
                        
                        // æ—¥ä»˜ã‚’æ—¥æœ¬èªå½¢å¼ã§è¡¨ç¤º
                        const memoDate = new Date(memo.date);
                        const formattedDate = memoDate.toLocaleDateString('ja-JP', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });

                        historyCard.innerHTML = `
                            <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">
                                ğŸ“… ${formattedDate}
                            </div>
                            ${memo.condition ? `
                                <div style="margin-bottom: 6px;">
                                    <span style="font-weight: 600; color: #666;">ç—…çŠ¶:</span> ${memo.condition}
                                </div>
                            ` : ''}
                            ${memo.prescription ? `
                                <div style="margin-bottom: 6px;">
                                    <span style="font-weight: 600; color: #666;">å‡¦æ–¹ç®‹:</span> ${memo.prescription}
                                </div>
                            ` : ''}
                            ${memo.other ? `
                                <div style="margin-bottom: 6px;">
                                    <span style="font-weight: 600; color: #666;">ãã®ä»–:</span> ${memo.other}
                                </div>
                            ` : ''}
                            <div style="font-size: 0.9em; color: #999; margin-top: 8px;">
                                ğŸ‘¨â€âš•ï¸ æ‹…å½“åŒ»å¸«: ${memo.doctorName || 'åŒ»å¸«'}
                            </div>
                        `;
                        historyContainer.appendChild(historyCard);
                    });

                    // æœ€çµ‚è¨ºæ–­æ—¥ã‚’æ›´æ–°
                    if (memos.length > 0) {
                        // æ—¥ä»˜ã‚’æ¯”è¼ƒã—ã¦æœ€æ–°ã®ãƒ¡ãƒ¢ã‚’ç‰¹å®š
                        let latestMemo = memos[0];
                        let latestDate = new Date(memos[0].date);
                        
                        memos.forEach(memo => {
                            const memoDate = new Date(memo.date);
                            if (memoDate > latestDate) {
                                latestDate = memoDate;
                                latestMemo = memo;
                            }
                        });
                        
                        const lastVisitElement = document.getElementById('lastVisit');
                        if (lastVisitElement) {
                            lastVisitElement.textContent = latestDate.toLocaleDateString('ja-JP', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                        }
                    }
                } else {
                    historyContainer.innerHTML = '<div class="diagnosis-entry">æ‚£è€…ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                }
            } catch (error) {
                console.error('è¨ºæ–­å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                document.getElementById('diagnosisHistory').innerHTML = 
                    '<div class="diagnosis-entry" style="color: #f44336;">è¨ºæ–­å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ã‚¯ã‚¤ã‚ºçµæœã®å–å¾—ã¨è¡¨ç¤º
        async function loadQuizResults() {
            try {
                let quizContainer = document.getElementById('quizResults');
                quizContainer.innerHTML = '';
                let quizList = [];

                // 1. AIã‚¯ã‚¤ã‚ºçµæœã‚’å–å¾—ï¼ˆai_quiz_scoresã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
                try {
                    const aiQuizSnapshot = await db.collection('ai_quiz_scores')
                        .where('userId', '==', patientId)
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    aiQuizSnapshot.forEach(doc => {
                        const data = doc.data();
                        quizList.push({
                            ...data,
                            category: 'AIã‚¯ã‚¤ã‚º',
                            date: data.timestamp && data.timestamp.toDate ? 
                                data.timestamp.toDate().toLocaleDateString('ja-JP', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }) : '-',
                            scoreValue: data.accuracy ? `${Math.round(data.accuracy * 100)}%` : '-',
                            quizName: 'AIè¨ºæ–­ã‚¯ã‚¤ã‚º',
                            correctAnswers: data.correctAnswers || 0,
                            totalQuestions: data.totalQuestions || 5
                        });
                    });
                } catch (error) {
                    console.log('AIã‚¯ã‚¤ã‚ºçµæœã®å–å¾—ã«å¤±æ•—:', error);
                }

                // 2. å‹•ç”»ã‚¯ã‚¤ã‚ºçµæœã‚’å–å¾—ï¼ˆmovie_quiz_scoresã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
                try {
                    const movieQuizSnapshot = await db.collection('movie_quiz_scores')
                        .where('userId', '==', patientId)
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    movieQuizSnapshot.forEach(doc => {
                        const data = doc.data();
                        quizList.push({
                            ...data,
                            category: 'å‹•ç”»ã‚¯ã‚¤ã‚º',
                            date: data.timestamp && data.timestamp.toDate ? 
                                data.timestamp.toDate().toLocaleDateString('ja-JP', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }) : '-',
                            scoreValue: data.accuracy ? `${Math.round(data.accuracy * 100)}%` : '-',
                            quizName: 'å‹•ç”»å­¦ç¿’ã‚¯ã‚¤ã‚º',
                            correctAnswers: data.correctAnswers || 0,
                            totalQuestions: data.totalQuestions || 5
                        });
                    });
                } catch (error) {
                    console.log('å‹•ç”»ã‚¯ã‚¤ã‚ºçµæœã®å–å¾—ã«å¤±æ•—:', error);
                }

                // 3åŒºåˆ†ï¼‹ãã®ä»–ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const CATEGORIES = ['åŸºç¤çŸ¥è­˜', 'è‡¨åºŠ', 'å€«ç†'];
                const grouped = { 'åŸºç¤çŸ¥è­˜': [], 'è‡¨åºŠ': [], 'å€«ç†': [], 'ãã®ä»–': [] };
                quizList.forEach(q => {
                    const cat = CATEGORIES.includes(q.category) ? q.category : 'ãã®ä»–';
                    grouped[cat].push(q);
                });
                CATEGORIES.concat(['ãã®ä»–']).forEach(cat => {
                    if (grouped[cat].length > 0) {
                        const block = document.createElement('div');
                        block.className = 'quiz-category-block';
                        block.innerHTML = `<h3>${cat}</h3>`;
                        grouped[cat].forEach(q => {
                            const quizCard = document.createElement('div');
                            quizCard.className = 'quiz-entry';
                            quizCard.innerHTML = `
                                <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">
                                    ğŸ“… ${q.date}
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <span style="font-weight: 600; color: #666;">ã‚¯ã‚¤ã‚ºå:</span> ${q.quizName || '-'}
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <span style="font-weight: 600; color: #666;">ã‚¹ã‚³ã‚¢:</span> ${q.scoreValue}
                                </div>
                                <div style="font-size: 0.9em; color: #999;">
                                    ğŸ¯ æ­£è§£: ${q.correctAnswers || 0}å• / ç·å•é¡Œæ•°: ${q.totalQuestions || 5}å•
                                </div>
                            `;
                            block.appendChild(quizCard);
                        });
                        quizContainer.appendChild(block);
                    }
                });
            } catch (error) {
                console.error('ã‚¯ã‚¤ã‚ºçµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        window.addEventListener('load', () => {
            if (patientId) {
                loadPatientData();
                loadDiagnosisHistory();
                loadQuizResults();
            } else {
                console.error('æ‚£è€…IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        });
    </script>
</body>
</html>

