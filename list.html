<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="æ‚£è€…è¨ºç™‚è¨˜éŒ²">æ‚£è€…è¨ºç™‚è¨˜éŒ²</title>
    <link rel="stylesheet" href="d_maintab.css">
    <link rel="stylesheet" href="responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- ç¿»è¨³æ©Ÿèƒ½ -->
    <script src="translation.js"></script>
   
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 data-translate="åŒ»ç™‚ç®¡ç†ã‚¢ãƒ—ãƒª">åŒ»ç™‚ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
        </div>

        <div class="tab-container">
            <div class="tab-header">
                <button class="tab-button" onclick="location.href='home.html'">
                    <span class="tab-icon">ğŸ¥</span>
                    <span class="tab-text" data-translate="HOME">HOME</span>
                </button>
                <button class="tab-button active" onclick="location.href='list.html'">
                    <span class="tab-icon">ğŸ‘¥</span>
                    <span class="tab-text" data-translate="æ‚£è€…è¨ºç™‚è¨˜éŒ²">æ‚£è€…è¨ºç™‚è¨˜éŒ²</span>
                </button>
                <button class="tab-button" onclick="location.href='chat.html'">
                    <span class="tab-icon">ğŸ“…</span>
                    <span class="tab-text" data-translate="ãƒãƒ£ãƒƒãƒˆ">ãƒãƒ£ãƒƒãƒˆ</span>
                </button>
                <button class="tab-button" onclick="location.href='docterprofile.html'">
                    <span class="tab-icon">ğŸ‘¤</span>
                    <span class="tab-text" data-translate="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
                </button>
            </div>
            
            <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <button class="hamburger-menu show-mobile">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        
        <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="mobile-menu">
            <a href="home.html">ğŸ¥ HOME</a>
            <a href="list.html">ğŸ‘¥ æ‚£è€…è¨ºç™‚è¨˜éŒ²</a>
            <a href="chat.html">ğŸ“… ãƒãƒ£ãƒƒãƒˆ</a>
            <a href="docterprofile.html">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
        </div>
        
        <div class="flex-container">
            <div class="patient-list-panel">
                <h2><i class="fas fa-user-friends"></i> <span data-translate="æ‹…å½“æ‚£è€…ãƒªã‚¹ãƒˆ">æ‹…å½“æ‚£è€…ãƒªã‚¹ãƒˆ</span></h2>
                <div class="search-box">
                    <input type="text" id="patientSearch" data-translate="æ‚£è€…ã‚’æ¤œç´¢..." placeholder="æ‚£è€…ã‚’æ¤œç´¢...">
                    <i class="fas fa-search"></i>
                </div>
                <div class="chat-list" id="patientList"></div>
            </div>
            <div class="memo-area" id="memoArea">
                <!-- é¸æŠä¸­ã®æ‚£è€…ã®è¨ºç™‚ãƒ¡ãƒ¢ãƒ•ã‚©ãƒ¼ãƒ ï¼‹å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script src="responsive.js"></script>
    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC31W-TEE7mIBGFwrRxJAuPugjnEFfWe_k",
      authDomain: "web01-2484d.firebaseapp.com",
      projectId: "web01-2484d",
      storageBucket: "web01-2484d.appspot.com",
      messagingSenderId: "90159472898",
      appId: "1:90159472898:web:261ec71f9919611011e21b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentUserId = null;
    let patients = [];
    let selectedPatientId = null;

    // æ‹…å½“æ‚£è€…ãƒªã‚¹ãƒˆå–å¾—
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
        window.location.href = 'login.html';
        return;
      }
      currentUserId = user.uid;
      // usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æ‹…å½“æ‚£è€…ã‚’å–å¾—
      const patientsSnapshot = await db.collection('users')
        .where('role', '==', 'patient')
        .where('assignedDoctor', '==', currentUserId)
        .get();
      patients = patientsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderPatientList();
    });

    function renderPatientList() {
      const listDiv = document.getElementById('patientList');
      listDiv.innerHTML = '';
      if (patients.length === 0) {
        listDiv.innerHTML = '<p style="color:var(--text-color-muted,#4A4A4A);text-align:center;margin:32px 0;">æ‹…å½“æ‚£è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
        document.getElementById('memoArea').innerHTML = '';
        return;
      }
      patients.forEach(patient => {
        const item = document.createElement('div');
        item.className = 'chat-item' + (selectedPatientId === patient.id ? ' selected' : '');
        item.innerHTML = `
          <div class="doctor-avatar">${patient.name ? patient.name.charAt(0) : '?'}</div>
          <div class="chat-info">
            <div class="doctor-name">${patient.name || 'åç„¡ã—ã®æ‚£è€…'}</div>
            <div class="last-message">${patient.age ? patient.age + 'æ­³' : ''}</div>
          </div>
        `;
        item.onclick = () => {
          window.location.href = `log.html?uid=${patient.id}`;
        };
        listDiv.appendChild(item);
      });
      // æœ€åˆã®æ‚£è€…ã‚’è‡ªå‹•é¸æŠ
      if (!selectedPatientId && patients.length > 0) {
        selectPatient(patients[0].id);
      }
    }

    async function selectPatient(patientId) {
      selectedPatientId = patientId;
      const patient = patients.find(p => p.id === patientId);
      if (!patient) return;
      // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—
      const doc = await db.collection('users').doc(patientId).get();
      const data = doc.data();
      const memos = data.memos || [];
      renderMemoArea(patient, memos);
    }

    function renderMemoArea(patient, memos) {
      const area = document.getElementById('memoArea');
      const currentDate = new Date().toISOString().split('T')[0];
      
      area.innerHTML = `
        <h2><i class="fas fa-notes-medical"></i> ${patient.name} ã•ã‚“ã®è¨ºç™‚ãƒ¡ãƒ¢</h2>
        <form id="memoForm">
          <div class="memo-field">
            <label><i class="fas fa-calendar-alt"></i> è¨ºå¯Ÿæ—¥</label>
            <input type="date" class="memo-input" id="memoDate" value="${currentDate}">
          </div>
          <div class="memo-field">
            <label><i class="fas fa-stethoscope"></i> ç—…çŠ¶ <span style="color:#666;font-size:0.9em;">(å¿…é ˆ)</span></label>
            <textarea class="memo-input" id="memoCondition" rows="3" placeholder="æ‚£è€…ã®ç—‡çŠ¶ã‚„ç—…çŠ¶ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <div class="memo-field">
            <label><i class="fas fa-pills"></i> å‡¦æ–¹ç®‹</label>
            <textarea class="memo-input" id="memoPrescription" rows="3" placeholder="å‡¦æ–¹ã—ãŸè–¬ã‚„æ²»ç™‚å†…å®¹ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <div class="memo-field">
            <label><i class="fas fa-pen"></i> ãã®ä»–ã®ãƒ¡ãƒ¢</label>
            <textarea class="memo-input" id="memoOther" rows="2" placeholder="ãã®ä»–ã®æ³¨æ„äº‹é …ã‚„ãƒ¡ãƒ¢ãŒã‚ã‚Œã°è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <button class="save-btn" type="submit"><i class="fas fa-save"></i> è¨ºæ–­ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
        </form>
        <div class="memo-history">
          <h3><i class="fas fa-history"></i> ãƒ¡ãƒ¢å±¥æ­´ (${memos.length}ä»¶)</h3>
          ${memos.length === 0 ? '<p style="color:var(--text-color-muted,#4A4A4A);margin:12px 0;">ãƒ¡ãƒ¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>' : memos.map(memo => `
            <div class="memo-entry">
              <div class="memo-header">
                <div class="memo-date"><i class="fas fa-calendar-day"></i> ${memo.date}</div>
                <div class="memo-doctor" style="font-size:0.9em;color:#666;">
                  <i class="fas fa-user-md"></i> ${memo.doctorName || 'åŒ»å¸«'}
                </div>
              </div>
              <div class="memo-content">
                ${memo.condition ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-stethoscope"></i> ç—…çŠ¶:</span><span>${memo.condition}</span></div>` : ''}
                ${memo.prescription ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-pills"></i> å‡¦æ–¹ç®‹:</span><span>${memo.prescription}</span></div>` : ''}
                ${memo.other ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-pen"></i> ãã®ä»–:</span><span>${memo.other}</span></div>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      document.getElementById('memoForm').onsubmit = async function(e) {
        e.preventDefault();
        
        // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
        const now = new Date();
        const currentDate = now.toISOString().split('T')[0];
        
        const newMemo = {
          date: document.getElementById('memoDate').value || currentDate,
          condition: document.getElementById('memoCondition').value,
          prescription: document.getElementById('memoPrescription').value,
          other: document.getElementById('memoOther').value,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          doctorId: currentUserId,
          doctorName: firebase.auth().currentUser?.displayName || 'åŒ»å¸«'
        };
        
        if (!newMemo.condition && !newMemo.prescription && !newMemo.other) {
          alert('å°‘ãªãã¨ã‚‚ç—…çŠ¶ã€å‡¦æ–¹ç®‹ã€ãã®ä»–ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        try {
          // æ—¢å­˜ã®ãƒ¡ãƒ¢é…åˆ—ã‚’å–å¾—
          const patientDoc = await db.collection('users').doc(patient.id).get();
          const existingMemos = patientDoc.data().memos || [];
          
          // æ–°ã—ã„ãƒ¡ãƒ¢ã‚’é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
          existingMemos.unshift(newMemo);
          
          // Firebaseã«ä¿å­˜
          await db.collection('users').doc(patient.id).update({ 
            memos: existingMemos,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          alert('è¨ºæ–­ãƒ¡ãƒ¢ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
          
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
          document.getElementById('memoCondition').value = '';
          document.getElementById('memoPrescription').value = '';
          document.getElementById('memoOther').value = '';
          document.getElementById('memoDate').value = currentDate;
          
          // æ‚£è€…æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
          await selectPatient(patient.id);
          
        } catch (error) {
          console.error('ãƒ¡ãƒ¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      };
    }

    document.getElementById('patientSearch').addEventListener('input', function(e) {
        const searchText = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.chat-item');
        items.forEach(item => {
            const name = item.querySelector('.doctor-name').textContent.toLowerCase();
            item.style.display = name.includes(searchText) ? 'flex' : 'none';
        });
    });
    </script>
</body>
</html>
