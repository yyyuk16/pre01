<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>クイズ結果</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="maintab.css">
    <link rel="stylesheet" href="responsive.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>クイズ結果</h1>
        </div>
        
        <div class="tab-container">
            <div class="tab-header">
                <button class="tab-button" onclick="location.href='ai.html'">
                    <span class="tab-icon">🤖</span>
                    <span class="tab-text">AI学習</span>
                </button>
                <button class="tab-button" onclick="location.href='movie.html'">
                    <span class="tab-icon">🎬</span>
                    <span class="tab-text">動画学習</span>
                </button>
                <button class="tab-button" onclick="location.href='allq&a.html'">
                    <span class="tab-icon">📝</span>
                    <span class="tab-text">クイズ</span>
                </button>
                <button class="tab-button active" onclick="location.href='score.html'">
                    <span class="tab-icon">📊</span>
                    <span class="tab-text">成績</span>
                </button>
            </div>
            
            <!-- モバイル用ハンバーガーメニュー -->
            <button class="hamburger-menu show-mobile">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        
        <!-- モバイルメニュー -->
        <div class="mobile-menu">
            <a href="ai.html">🤖 AI学習</a>
            <a href="movie.html">🎬 動画学習</a>
            <a href="allq&a.html">📝 クイズ</a>
            <a href="score.html">📊 成績</a>
        </div>

        <!-- クイズ開始ボタン -->
        <div class="quiz-start-section">
            <button onclick="location.href='allq&a.html'" class="start-quiz-btn">
                🚀 クイズを開始
            </button>
        </div>

        <!-- 学習進捗の可視化 -->
        <div class="progress-section">
            <h2>学習進捗</h2>
            <div class="progress-grid">
                <div class="progress-card">
                    <div class="progress-icon">📚</div>
                    <h3>総クイズ数</h3>
                    <div class="progress-number" id="totalQuizzes">0</div>
                </div>
                <div class="progress-card">
                    <div class="progress-icon">🎯</div>
                    <h3>平均正答率</h3>
                    <div class="progress-number" id="averageAccuracy">0%</div>
                </div>
                <div class="progress-card">
                    <div class="progress-icon">📈</div>
                    <h3>最高スコア</h3>
                    <div class="progress-number" id="highestScore">0%</div>
                </div>
                <div class="progress-card">
                    <div class="progress-icon">🔥</div>
                    <h3>連続正解</h3>
                    <div class="progress-number" id="streak">0</div>
                </div>
            </div>
        </div>

        <!-- スコアトレンドグラフ -->
        <div class="chart-section">
            <h2>スコアトレンド</h2>
            <div class="chart-container">
                <canvas id="scoreChart"></canvas>
            </div>
        </div>

        <!-- クイズ結果一覧 -->
        <div class="results-section">
            <h2>クイズ結果一覧</h2>
            <div id="quizResults" class="results-grid">
                <!-- 結果がここに動的に追加されます -->
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="responsive.js"></script>
    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyC31W-TEE7mIBGFwrRxJAuPugjnEFfWe_k",
            authDomain: "web01-2484d.firebaseapp.com",
            projectId: "web01-2484d",
            storageBucket: "web01-2484d.appspot.com",
            messagingSenderId: "90159472898",
            appId: "1:90159472898:web:261ec71f9919611011e21b"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;
        let quizScores = [];

        // ユーザー認証状態の監視
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                currentUser = user;
                loadQuizScores();
            } else {
                console.log('ユーザーがログインしていません');
            }
        });

        // クイズスコアの読み込み
        async function loadQuizScores() {
            try {
                const snapshot = await db.collection('ai_quiz_scores')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .get();

                quizScores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    quizScores.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date()
                    });
                });

                displayResults();
                updateProgress();
                createChart();
            } catch (error) {
                console.error('クイズスコアの読み込みに失敗:', error);
            }
        }

        // 結果の表示
        function displayResults() {
            const resultsContainer = document.getElementById('quizResults');
            resultsContainer.innerHTML = '';

            if (quizScores.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">まだクイズ結果がありません</div>';
                return;
            }

            quizScores.forEach(score => {
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                
                const date = score.timestamp.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const accuracy = score.accuracy ? Math.round(score.accuracy * 100) : 0;
                
                resultCard.innerHTML = `
                    <div class="result-header">
                        <span class="result-date">📅 ${date}</span>
                        <span class="result-score">${accuracy}%</span>
                    </div>
                    <div class="result-details">
                        <div class="result-item">
                            <span class="label">正解数:</span>
                            <span class="value">${score.correct || 0}問</span>
                        </div>
                        <div class="result-item">
                            <span class="label">総問題数:</span>
                            <span class="value">${score.total || 5}問</span>
                        </div>
                    </div>
                `;
                
                resultsContainer.appendChild(resultCard);
            });
        }

        // 進捗の更新
        function updateProgress() {
            if (quizScores.length === 0) return;

            const totalQuizzes = quizScores.length;
            const totalAccuracy = quizScores.reduce((sum, score) => sum + (score.accuracy || 0), 0);
            const averageAccuracy = totalAccuracy / totalQuizzes;
            const highestScore = Math.max(...quizScores.map(score => score.accuracy || 0));
            
            // 連続正解の計算（簡易版）
            let streak = 0;
            for (let i = 0; i < quizScores.length; i++) {
                if ((quizScores[i].accuracy || 0) >= 0.8) {
                    streak++;
                } else {
                    break;
                }
            }

            document.getElementById('totalQuizzes').textContent = totalQuizzes;
            document.getElementById('averageAccuracy').textContent = Math.round(averageAccuracy * 100) + '%';
            document.getElementById('highestScore').textContent = Math.round(highestScore * 100) + '%';
            document.getElementById('streak').textContent = streak;
        }

        // チャートの作成
        function createChart() {
            if (quizScores.length === 0) return;

            const ctx = document.getElementById('scoreChart').getContext('2d');
            
            // 既存のチャートを破棄
            if (window.scoreChart) {
                window.scoreChart.destroy();
            }

            const labels = quizScores.slice(0, 10).reverse().map(score => {
                const date = score.timestamp;
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });

            const data = quizScores.slice(0, 10).reverse().map(score => 
                Math.round((score.accuracy || 0) * 100)
            );

            window.scoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '正答率 (%)',
                        data: data,
                        borderColor: '#43a047',
                        backgroundColor: 'rgba(67, 160, 71, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>

    <style>
        .quiz-start-section {
            text-align: center;
            margin: 2rem 0;
        }

        .start-quiz-btn {
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(67, 160, 71, 0.3);
        }

        .start-quiz-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 160, 71, 0.4);
        }

        .progress-section {
            margin: 2rem 0;
        }

        .progress-section h2 {
            color: var(--text-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .progress-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(67, 160, 71, 0.1);
            transition: transform 0.3s ease;
        }

        .progress-card:hover {
            transform: translateY(-5px);
        }

        .progress-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .progress-card h3 {
            color: var(--text-color);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .progress-number {
            font-size: 2rem;
            font-weight: 700;
            color: #43a047;
        }

        .chart-section {
            margin: 2rem 0;
        }

        .chart-section h2 {
            color: var(--text-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(67, 160, 71, 0.1);
            height: 400px;
        }

        .results-section {
            margin: 2rem 0;
        }

        .results-section h2 {
            color: var(--text-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .result-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(67, 160, 71, 0.1);
            transition: transform 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-3px);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e8f5e9;
        }

        .result-date {
            color: #666;
            font-size: 0.9rem;
        }

        .result-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: #43a047;
        }

        .result-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .label {
            color: #666;
            font-weight: 500;
        }

        .value {
            color: var(--text-color);
            font-weight: 600;
        }

        .no-results {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .progress-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .result-details {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }
        }
    </style>
</body>
</html>

